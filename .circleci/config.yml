version: 2
jobs:
  build:
    working_directory: /go-control-plane
    docker:
      - image: gcr.io/istio-testing/go-control-plane-ci:06-09-2020
    steps:
      - checkout
      - run: make create_version
      - run: make check_version_dirty
      - run: make build
      - run:
          command: mkdir logs && cp *.log logs/
          when: on_fail
      - store_artifacts:
          path: /go-control-plane/logs

  test:
    working_directory: /home/circleci/.go_workspace/github.com/envoyproxy/go-control-plane
    machine: true
    steps:
      - attach_workspace:
          at: .
      - run: sudo apt-get update && sudo apt-get install -y ca-certificates wget curl git openssh-client
      - run:
          name: Remove old Go version
          command: sudo rm -fR /usr/local/go
      - run:
          name: Install GO
          command: |
            wget -O go.tar.gz https://dl.google.com/go/go1.13.7.linux-amd64.tar.gz
            sudo tar -C /usr/local -xzf go.tar.gz
      - run: make test
      - run: make integration

workflows:
  version: 2
  build-and-test:
    jobs:
      - build:
          filters:
            tags:
              ignore: /.*/
            branches:
              only: /.*/
      - test:
          filters:
            tags:
              ignore: /.*/
            branches:
              only: /.*/
